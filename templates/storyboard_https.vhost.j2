<VirtualHost {{ fqdn }}:80>
{% if server_admin is defined %}
    ServerAdmin {{ server_admin }}
{% endif %}
    ServerName {{ fqdn }}

    DocumentRoot {{ www_root }}

    Redirect / https://{{ fqdn }}/

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/storyboard-error.log
    CustomLog ${APACHE_LOG_DIR}/storyboard-access.log combined

</VirtualHost>
<IfModule mod_ssl.c>
  <VirtualHost {{ fqdn }}:443>
{% if server_admin is defined %}
    ServerAdmin {{ server_admin }}
{% endif %}
    ServerName {{ fqdn }}

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/storyboard-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/storyboard-ssl-access.log combined

    SSLEngine on

    SSLCertificateFile      {{ ssl_cert }}
    SSLCertificateKeyFile   {{ ssl_key }}
{% if resolved_ssl_ca is defined %}
    SSLCertificateChainFile {{ resolved_ssl_ca }}
{% endif %}

    <FilesMatch "\.(cgi|shtml|phtml|php)$">
      SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
      SSLOptions +StdEnvVars
    </Directory>

    BrowserMatch "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

    DocumentRoot {{ www_root }}

    WSGIDaemonProcess storyboard user=www-data group=www-data threads=5 python-path=/usr/local/lib/python2.7/dist-packages
    WSGIScriptAlias /api /var/lib/storyboard/storyboard.wsgi
    WSGIPassAuthorization On

    <Directory "{{ install_root }}">
{% if apache_vhosts_version == "2.4" %}
        Require all granted
{% else %}
        Order allow,deny
        Allow from all
{% endif %}
    </Directory>
  </VirtualHost>
</IfModule>
